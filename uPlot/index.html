<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Resize</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://leeoniya.github.io/uPlot/dist/uPlot.min.css">

</head>

<body>
    <script src="https://unpkg.com/uplot@1.6.23/dist/uPlot.iife.min.js"></script>
    <script type="module">
        import JSON5 from 'https://unpkg.com/json5@2/dist/index.min.mjs';
        function transpose(array) {
            return array[0].map((_, colIndex) => array.map(row => row[colIndex]));
        }

        async function get_data(server_url, product, start_time, stop_time) {
            const response = await fetch(server_url + '/get_data?format=json&path=' + product + '&start_time=' + start_time + '&stop_time=' + stop_time);
            const json_from_server = JSON5.parse(await response.text())
            let data = transpose(json_from_server['values']['values']);
            data.unshift(json_from_server['axes'][0]['values'].map(function (item) { return item / 1000000.0 }));
            return data;
        }

        function getSize() {
            return {
                width: window.innerWidth - 100,
                height: window.innerHeight - 200,
            }
        }


        function line_plot(data) {
            let opts = {
                title: "My Chart",
                ...getSize(),
                series: [
                    {},
                    {
                        // initial toggled state (optional)
                        show: true,

                        spanGaps: false,

                        // in-legend display
                        label: "X",

                        // series style
                        stroke: "red",
                        width: 1
                    },
                    {
                        // initial toggled state (optional)
                        show: true,

                        spanGaps: false,

                        // in-legend display
                        label: "Y",

                        // series style
                        stroke: "red",
                        width: 1
                    }
                    ,
                    {
                        // initial toggled state (optional)
                        show: true,

                        spanGaps: false,

                        // in-legend display
                        label: "Z",

                        // series style
                        stroke: "red",
                        width: 1
                    }
                ],
            };

            let plot = new uPlot(opts, data, document.body);
            window.addEventListener("resize", e => {
                plot.setSize(getSize());
            });
        }
        const server_url = "http://sciqlop.lpp.polytechnique.fr/cache",
            product = "amda/c1_b_gsm";
        const start_time = "2018-10-24T02:00:00";
        const stop_time = "2018-10-25T02:05:00";

        //(async () => {
            line_plot(await get_data(server_url, product, start_time, stop_time));
       // })();


    </script>
</body>

</html>