<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Resize</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://leeoniya.github.io/uPlot/dist/uPlot.min.css">

</head>

<body>
    <script src="https://unpkg.com/uplot@1.6.23/dist/uPlot.iife.min.js"></script>
    <script type="module">
        import JSON5 from 'https://unpkg.com/json5@2/dist/index.min.mjs';
        function transpose(array) {
            return array[0].map((_, colIndex) => array.map(row => row[colIndex]));
        }

        async function get_data(server_url, product, start_time, stop_time) {
            const response = await fetch(server_url + '/get_data?format=json&path=' + product + '&start_time=' + start_time + '&stop_time=' + stop_time);
            const json_from_server = JSON5.parse(await response.text())
            let data = transpose(json_from_server['values']['values']);
            data.unshift(json_from_server['axes'][0]['values'].map(function (item) { return item / 1000000000.0 }));
            return data;
        }

        function getSize() {
            return {
                width: window.innerWidth - 100,
                height: window.innerHeight - 200,
            }
        }

        function color(i) {
            const palette = ['rgb(31, 119, 180)', 'rgb(255, 127, 14)', 'rgb(44, 160, 44)', 'rgb(214, 39, 40)', 'rgb(148, 103, 189)', 'rgb(140, 86, 75)',
                'rgb(227, 119, 194)', 'rgb(127, 127, 127)', 'rgb(188, 189, 34)', 'rgb(23, 190, 207)', 'rgb(31, 119, 180)', 'rgb(255, 127, 14)', 'rgb(44, 160, 44)', 'rgb(214, 39, 40)',
                'rgb(148, 103, 189)', 'rgb(140, 86, 75)', 'rgb(227, 119, 194)', 'rgb(127, 127, 127)', 'rgb(188, 189, 34)', 'rgb(23, 190, 207)', 'rgb(31, 119, 180)', 'rgb(255, 127, 14)',
                'rgb(44, 160, 44)', 'rgb(214, 39, 40)', 'rgb(148, 103, 189)', 'rgb(140, 86, 75)', 'rgb(227, 119, 194)', 'rgb(127, 127, 127)', 'rgb(188, 189, 34)', 'rgb(23, 190, 207)',
                'rgb(31, 119, 180)', 'rgb(255, 127, 14)']
            return palette[i % palette.length]
        }


        function line_plot(data) {
            let opts = {
                title: "My Chart",
                ...getSize(),
                tzDate: ts => uPlot.tzDate(new Date(ts * 1e3), 'UTC'),
                cursor: { drag: { x: true, y: true, uni: 50 } },
                series: [
                    {},
                    {
                        show: true,
                        spanGaps: false,
                        label: "X",
                        stroke: color(0),
                        width: 1
                    },
                    {
                        show: true,
                        spanGaps: false,
                        label: "Y",
                        stroke: color(1),
                        width: 1
                    }
                    ,
                    {
                        show: true,
                        spanGaps: false,
                        label: "Z",
                        stroke: color(2),
                        width: 1
                    }
                ],
            };

            let plot = new uPlot(opts, data, document.body);
            window.addEventListener("resize", e => {
                plot.setSize(getSize());
            });
        }
        const server_url = "http://sciqlop.lpp.polytechnique.fr/cache",
            product = "amda/c1_b_gsm";
        const start_time = "2018-10-24T00:00:00";
        const stop_time = "2018-10-25T02:05:00";

        (async () => {
            line_plot(await get_data(server_url, product, start_time, stop_time));
        })();


    </script>
</body>

</html>